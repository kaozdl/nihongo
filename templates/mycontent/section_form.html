{% extends "base.html" %}

{% block title %}{% if section %}{{ _('Edit Section') }}{% else %}{{ _('Create Section') }}{% endif %} - JLPT Test Manager{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        padding: 3rem 0;
        margin-bottom: 2rem;
        border-radius: 15px;
    }
    
    .form-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .form-label {
        font-weight: 600;
        color: #333;
    }
    
    .btn-save {
        background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        border: none;
        color: white;
        font-weight: 600;
        padding: 12px 30px;
        border-radius: 10px;
        transition: transform 0.3s ease;
    }
    
    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header text-center">
        <h1>
            <i class="bi bi-{% if section %}pencil-square{% else %}plus-circle{% endif %}"></i>
            {% if section %}{{ _('Edit Section') }}{% else %}{{ _('Create New Section') }}{% endif %}
        </h1>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card form-card">
                <div class="card-body p-4">
                    <form method="POST">
                        <!-- Section Name -->
                        <div class="mb-4">
                            <label for="name" class="form-label">
                                <i class="bi bi-folder"></i> {{ _('Section Name') }} *
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="name" 
                                   name="name" 
                                   value="{% if section %}{{ section.name }}{% endif %}" 
                                   placeholder="e.g., Grammar, Vocabulary, Kanji" 
                                   required>
                            <div class="form-text">{{ _('Choose a descriptive name for this section') }}</div>
                        </div>
                        
                        <!-- Number of Questions -->
                        <div class="mb-4">
                            <label for="number_of_questions" class="form-label">
                                <i class="bi bi-123"></i> {{ _('Maximum Number of Questions') }} *
                            </label>
                            <input type="number" 
                                   class="form-control" 
                                   id="number_of_questions" 
                                   name="number_of_questions" 
                                   value="{% if section %}{{ section.number_of_questions }}{% else %}10{% endif %}" 
                                   min="1" 
                                   max="100" 
                                   required>
                            <div class="form-text">{{ _('How many questions should this section contain?') }}</div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="mt-4 pt-3 border-top">
                            <button type="submit" class="btn btn-save">
                                <i class="bi bi-check-circle"></i> {% if section %}{{ _('Update Section') }}{% else %}{{ _('Create Section') }}{% endif %}
                            </button>
                            <a href="{{ url_for('mycontent.sections') }}" class="btn btn-outline-secondary ms-2">
                                <i class="bi bi-x-circle"></i> {{ _('Cancel') }}
                            </a>
                        </div>
                    </form>
                    
                    {% if section %}
                    <!-- Question Management (Only when editing) -->
                    <div class="mt-5 pt-4 border-top">
                        <h4 class="mb-4">
                            <i class="bi bi-question-circle"></i> {{ _('Section Questions') }}
                            <span class="badge bg-success">{{ section_questions|length }}</span>
                        </h4>
                        
                        <!-- Current Questions -->
                        {% if section_questions %}
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">{{ _('Current Questions') }}</h6>
                            <div class="accordion" id="questionsAccordion">
                                {% for section_question in section_questions %}
                                <div class="accordion-item mb-2">
                                    <h2 class="accordion-header" id="heading{{ section_question.id }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ section_question.id }}">
                                            <span class="badge bg-secondary me-2">{{ section_question.order }}</span>
                                            {{ section_question.question.question_text[:80] }}{% if section_question.question.question_text|length > 80 %}...{% endif %}
                                        </button>
                                    </h2>
                                    <div id="collapse{{ section_question.id }}" class="accordion-collapse collapse" data-bs-parent="#questionsAccordion">
                                        <div class="accordion-body">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <strong>{{ _('Answers') }}:</strong>
                                                    <div class="mt-2">
                                                        <div class="row">
                                                            <div class="col-6">
                                                                <span class="badge {% if section_question.question.correct_answer == 1 %}bg-success{% else %}bg-light text-dark{% endif %}">1</span> {{ section_question.question.answer_1 }}
                                                            </div>
                                                            <div class="col-6">
                                                                <span class="badge {% if section_question.question.correct_answer == 2 %}bg-success{% else %}bg-light text-dark{% endif %}">2</span> {{ section_question.question.answer_2 }}
                                                            </div>
                                                            <div class="col-6 mt-2">
                                                                <span class="badge {% if section_question.question.correct_answer == 3 %}bg-success{% else %}bg-light text-dark{% endif %}">3</span> {{ section_question.question.answer_3 }}
                                                            </div>
                                                            <div class="col-6 mt-2">
                                                                <span class="badge {% if section_question.question.correct_answer == 4 %}bg-success{% else %}bg-light text-dark{% endif %}">4</span> {{ section_question.question.answer_4 }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-4 text-end">
                                                    <form method="POST" style="display: inline;" class="mb-2">
                                                        <input type="hidden" name="section_question_id" value="{{ section_question.id }}">
                                                        <input type="number" 
                                                               name="new_order" 
                                                               value="{{ section_question.order }}" 
                                                               min="1" 
                                                               class="form-control form-control-sm d-inline-block mb-2" 
                                                               style="width: 60px;">
                                                        <button type="submit" 
                                                                name="update_question_order" 
                                                                value="1" 
                                                                class="btn btn-sm btn-outline-info">
                                                            <i class="bi bi-arrow-up-down"></i> {{ _('Reorder') }}
                                                        </button>
                                                    </form>
                                                    <br>
                                                    <form method="POST" 
                                                          style="display: inline;"
                                                          onsubmit="return confirm('{{ _('Remove this question from the section?') }}');">
                                                        <input type="hidden" name="section_question_id" value="{{ section_question.id }}">
                                                        <button type="submit" 
                                                                name="remove_question" 
                                                                value="1" 
                                                                class="btn btn-sm btn-outline-danger">
                                                            <i class="bi bi-trash"></i> {{ _('Remove') }}
                                                        </button>
                                                    </form>
                                                    <a href="{{ url_for('mycontent.edit_question', id=section_question.question.id) }}" 
                                                       class="btn btn-sm btn-outline-primary ms-1">
                                                        <i class="bi bi-pencil"></i> {{ _('Edit Question') }}
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> {{ _('No questions added yet. Add existing questions or create new ones below.') }}
                        </div>
                        {% endif %}
                        
                        <!-- Add Existing Question -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-plus-circle"></i> {{ _('Add Existing Question') }}
                                </h6>
                            </div>
                            <div class="card-body">
                                <form method="POST">
                                    <div class="row align-items-end">
                                        <div class="col-md-9">
                                            <label for="question_id" class="form-label">{{ _('Select Question') }}</label>
                                            <select class="form-select" id="question_id" name="question_id" required>
                                                <option value="">{{ _('Choose a question...') }}</option>
                                                {% for question in my_questions %}
                                                <option value="{{ question.id }}">
                                                    {{ question.question_text[:80] }}{% if question.question_text|length > 80 %}...{% endif %}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <button type="submit" name="add_question" value="1" class="btn btn-primary w-100">
                                                <i class="bi bi-plus"></i> {{ _('Add') }}
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Create New Question Inline -->
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-stars"></i> {{ _('Create New Question') }}
                                </h6>
                            </div>
                            <div class="card-body">
                                <form method="POST">
                                    <div class="mb-3">
                                        <label for="new_question_text" class="form-label">{{ _('Question Text') }} *</label>
                                        <textarea class="form-control" 
                                                  id="new_question_text" 
                                                  name="new_question_text" 
                                                  rows="2" 
                                                  required></textarea>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label">{{ _('Answer 1') }} *</label>
                                            <input type="text" class="form-control" name="new_answer_1" required>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label">{{ _('Answer 2') }} *</label>
                                            <input type="text" class="form-control" name="new_answer_2" required>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label">{{ _('Answer 3') }} *</label>
                                            <input type="text" class="form-control" name="new_answer_3" required>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label">{{ _('Answer 4') }} *</label>
                                            <input type="text" class="form-control" name="new_answer_4" required>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="new_correct_answer" class="form-label">{{ _('Correct Answer') }} *</label>
                                        <select class="form-select" id="new_correct_answer" name="new_correct_answer" required>
                                            <option value="">{{ _('Select correct answer...') }}</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                        </select>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label">{{ _('Explanation (English)') }}</label>
                                            <textarea class="form-control" name="new_explanation_en" rows="2"></textarea>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <label class="form-label">{{ _('Explanation (Español)') }}</label>
                                            <textarea class="form-control" name="new_explanation_es" rows="2"></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <button type="submit" name="create_question" value="1" class="btn btn-success">
                                            <i class="bi bi-plus-circle"></i> {{ _('Create & Add Question') }}
                                        </button>
                                    </div>
                                    
                                    <div class="form-text mt-2">
                                        <i class="bi bi-info-circle"></i> {{ _('The question will be created and automatically added to this section.') }}
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

